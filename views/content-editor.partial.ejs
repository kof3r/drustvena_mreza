<style>
#editor {
}
.wysibb {
	width: 100%;
	-webkit-box-sizing: content-box !important;
    -moz-box-sizing: content-box !important;
    box-sizing: content-box !important;
    float: left;

}
.wysibb-text-editor, .wysibb-texarea {
	min-height: 150px !important;
	padding: 15px; 
}
#main-content { box-sizing: border-box }
</style>

<% if(locals.error) { %><div class="alert alert-danger">The content with the specified ID does not exist</div><% } else { %>

<form name="post-form" id="post-form">

	<div class="form-group col-sm-8 col-xs-12">
		<label for="post-title">Title</label>
			<input type="text" id="post-title" name="post-title" class="form-control" maxlength="128"<% if(locals.post) { %>value="<%= post.title %>"<% } %> />
	</div>
	
	<% if(!locals.post) { %>
	<div class="form-group col-sm-4">
		<label for="bubble-to-post-in">Bubble</label>
		<select id="bubble-to-post-in" name="bubble-to-post-in" class="form-control">
		</select>
	</div>
	<% } %>
	
	<div class="col-md-8 col-sm-8">
		<label>Category</label>
		<div class="form-group">
			<div class="btn-group">
				<label class="">
					<input id="new-content-category-post" name="category" value="1" type="radio">
					<span class="glyphicon glyphicon-font"></span> Post
				</label>
				<!--
				<label class="">
					<input id="new-content-category-picture" name="category" value="2" type="radio">
					<span class="glyphicon glyphicon-picture"></span> Picture
				</label>
				<label class="">
					<input id="new-content-category-music" name="category" value="3" type="radio">
					<span class="glyphicon glyphicon-music"></span> Music
				</label>
				<label class="">
					<input id="new-content-category-video" name="category" value="4" type="radio">
					<span class="glyphicon glyphicon-facetime-video"></span> Video
				</label>
				-->
			</div>
		</div>
	</div>
	
	<div class="col-sm-3 col-xs-8">
		<label>Actions</label>
		<div class="form-group">
      <% if(locals.post) { %>
        <input type="submit" class="btn btn-success " value="Update" />
			<% } else { %>
        <input type="submit" class="btn btn-primary " value="Publish" />
      <% } %>
			<button class="btn btn-danger" onclick="Javascript:discard();">Discard</button>
		</div>
	</div>

</form>

	<div class="col-md-12 editor">
			<textarea id="editor"><% if(locals.post) { %><%= post.content %><% } %></textarea>
	</div>
	

<!-- Editor -->
<script src="/javascripts/jquery.wysibb.min.js"></script>

<!-- My Bubbles -->
<script id="new-post-bubble-select-tmp" type="text/x-dot-template">
	<option></option>
	{{~it.bubbles :bubble:index}}
      {{? bubble.bubble_type_id != 2 }}
          <option value="{{= bubble.id }}">{{= escapeHtml(bubble.title) }}</option>
      {{?}}
	{{~}}
</script>

<script>

function setCategory(type) {
	$('#new-content-category-' + type).attr('checked', 'checked');
}

function renderEditor() {
    var wbbOpt = {
    buttons: "bold,italic,underline,strike,mark,|,left,text-center,right,|,link,img,video,|,table,qoute,code|"
    }
    $("#editor").wysibb(wbbOpt);
    
    <% if(!locals.post) { %>
      $.get('/api/content/myBubbles', function(data) {
        var templateFunction = doT.template(document.getElementById('new-post-bubble-select-tmp').text);
        var html = templateFunction(data);
        $('#bubble-to-post-in').html(html);
      });
    <% } %>
}

function discard() {
	window.history.back();
}

$('#post-form').on('submit', function(event) {
	event.preventDefault();
	
	var title = document.getElementById('post-title').value;
	var bubble_id = <% if(locals.post) { %><%= post.bubble_id %><% } else { %>$('#bubble-to-post-in').val()<% } %>;
	var content = $("#editor").bbcode();
	var postData = {content: content,
                  title: title,
                  <% if(locals.post) { %>
                  id: <%= post.id %>,
                  <% } else { %>
                  bubble_id: bubble_id,<% } %>
                  description: ''};
	
	if (title == '')	{ $('#post-title').focus();}
	else if (bubble_id == '') { $('#bubble-to-post-in').focus();}
	else if (content == '') { $('#editor').focus();}
					
	else {
    var url = '/api/content/<% if(locals.post) { %>edit/post/' + <%= post.id %><% } else { %>post/' + bubble_id<% } %>;
		$.post(url, postData, function(success) {
      window.location = '/bubble/' + bubble_id;
		});
	}
	return false;
});

$(document).ready(renderEditor);

</script>
<% } %>