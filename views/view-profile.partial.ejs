<style>

    .jumbotron {
        background: url("/images/bubbles-profile.jpg") center center; 
        background-size: cover;
        overflow: hidden;
        height: 270px;
        z-index: 0;
    }

    .image-profile {
        margin-right: 3%;
        border-bottom: groove;
    }

    .well-profile {
        width: 85%;
        margin: auto;
        margin-top: 2.5%;
    }

    div[class="pinfo_part"] {
        margin: 5%;
    }

    .pinfo_part > h4 {
        color: dodgerblue;
        font-weight: bold;
    }

    .pinfo_part > p {
        text-indent: 5%;
        font-weight: bold;
    }

    .friends-tab {
        margin: auto;
        margin-top: 2.5%;
    }

    .my-friends {
        color: dodgerblue;
        font-weight: bold;
    }


    .avatar {
        margin: -160px 10px 20px 0px;
        z-index: 9;
    }

    .profile-name {
        color: white;
        padding: 25px;
        text-shadow: 4px 4px 5px #000000;
    }

    .profile-name > h1 {
        font-size: 40px;
        font-weight: bold;
    }
    .profile-name > p {
        font-size: 16px;
        font-style: italic;
    }

    .btn-primary {
        background-color: dodgerblue;
        font-weight: bold;
        border: 0px;
    }

    .btn-primary:hover {
        background-color: lightblue;
    }

    #edit_btn {
        float: right;
        margin: 2%;
    }

    #main-content div.tab-pane {
        margin: 10px;
    }

    .nav-pills a, .nav-pills a:hover, .nav-pills a:focus {
        outline: 0;
        color: black;
        font-size: 1.2em;
    }

    .nav-pills > li.active > a:focus {
        background-color: darkorange;
        color: white;
    } 
    
    /* bubbles tab */
    #bubbles a {
        text-decoration: none;
        text-align: center;
        background-color: white;
        border-radius: 25px;
        border: 5px orange solid;
        display: block;
        float: left;
        margin: 5px 10px;
    }
    
    #bubbles dl dt {
        padding: 5px;
    }
    
    #bubbles dl dd {
        padding: 5px 5px 5px 15px;
    }

    /* contacts tab */
    .my-friends > ul.friends-list {
        list-style: none;
        clear: left;
    }

    .my-friends > ul.friends-list > li {
        text-align: center;
    }
    .my-friends > ul.friends-list:last-child {
        clear: left;
    }
    .my-friends > ul.friends-list > li > a {
        float: left;
        display: block;
        text-decoration: none;
        padding: 10px;
        margin: 5px;
        border: 1px solid;
        border-radius: 5px;
    }
    .my-friends > ul.friends-list > li > a > div {
        font-size: 0.9em;
        color: darkgrey;
    }
    .my-friends div {
        clear: both;
    }

    /* Timeline */
    #timeline > .page-header {
        display: none;
    }

</style>

<div class="jumbotron">
    <div class="row">
        <div class="col-md-8">
        </div>
        <% if(user.isMyProfile == false) { %>
        <div class="col-md-2">
            <button class="btn btn-danger" id="removeFriendButton" name="/api/user/removeContact">Remove from contacts</button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary" id="addFriendButton" name="/api/user/contactRequest">Add to contacts</button>
        </div> 
        <% } %>
    </div>
    <div align="right"  class="profile-name"><p>Been with us since <% if(locals.user) { %><%= user.created_at %> <% } %></p></div>
</div>
<div>
    <div class="avatar">
        <a href="<%= user.avatar %>?size=large" class="image-popup-no-margins">
            <img align="left" class="image-profile img-circle" src="<%= user.avatar %>?size=small" width="125" height="125" alt="Profile image"/>
        </a>
        <div class="profile-name">
            <h1><% if(locals.user) { %><%= user.username %><% } %></h1>
            <h4><% if(locals.user) { %><%= user.first_name %> <%= user.last_name %><% } %></h4>
        </div>
    </div>
    <ul class="nav nav-pills profile-tabs" id="navList">
        <li role="presentation" class="active"><a data-toggle="pill" href="#info">Info</a></li>
        <li role="presentation"><a data-toggle="pill" href="#bubbles">Bubbles</a></li>
        <li role="presentation"><a data-toggle="pill" href="#timeline">Timeline</a></li>
        <li role="presentation"><a data-toggle="pill" href="#gallery" id="galleryNavPill">Gallery</a></li>
        <li role="presentation"><a data-toggle="pill" href="#contacts" id="view-contacts-button">Contacts</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade in active" id="info">
            <div class="well well-profile">
                <% if(user.isMyProfile == true) { %>
                <a id="edit_btn" href="/profile/edit" class="btn btn-primary" role="button"><span class="glyphicon glyphicon-wrench"></span> Edit</a>
                <% } %>
                <div class="pinfo_part">
                    <h4>Full name:</h4>
                    <p><% if(locals.user) { %><%= user.first_name %> <%= user.middle_name %> <%= user.last_name %><% } %></p>
                    <% if(user.isMyProfile) { %>
                        <h4>E-mail:</h4>
                        <p><% if(locals.user) { %><%= user.email %><% } %></p>
                    <% } %>
                    <h4>Birthday:</h4>
                    <p><% if(locals.user) { %><%= user.date_of_birth %><% } %></p>
                </div>

                <div class="pinfo_part">
                    <% if(user.gender_id) { %>
                        <h4>Gender:</h4>
                        <p><% if(user.gender_id==2){%>Male<%}%><% if(user.gender_id==1){%>Female<%}%><% if(!user.gender_id){%>Other<%}%></p>
                    <% } %>
                    <h4>Relationship status:</h4>
                    <p><% if(user.relationship_status_id==1){%>Single<%}%><% if(user.relationship_status_id==2){%>Complicated<%}%><%                                              if(user.relationship_status_id==3){%>In a relationship<%}%><% if(user.relationship_status_id==4){%>Other<%}%> </p>
                </div>

                <div class="pinfo_part">
                    <h4>Living at:</h4>
                    <p><% if(user.address) { %><%= user.address %>, <% } if(user.city) { %><%= user.city %>,<% } if(user.country_name) { %> <%= user.country_name %><% } %> </p>
                </div>

                <div class="pinfo_part">
                    <h4>Account created:</h4>
                    <p>
                        <% if(locals.user) { %>
                        <%= user.created_at %> 
                        <% } %>
                    </p>
                    <% if(user.updated_at) { %>
                        <h4>Last account update:</h4>
                        <p><% if(locals.user) { %><%= user.updated_at %> <% } %> </p>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="bubbles">
        </div>
        <div class="tab-pane fade" id="timeline">
        </div>


        <div class="tab-pane fade" id="contacts">
            <div class="friends-tab" >
                <div class="my-friends" >
                </div>
            </div>     
        </div>


        <div class="tab-pane fade" id="gallery">
            <div id="profile-gallery">
                <!--  Ovdje Ä‡e JQuery ubacit slike  -->
            </div>
            <div class="row">
                <div class="col-md-6">
                </div>

                <div class="col-md-6">
                    <button class="btn btn-primary" id="newImageButton">
                        Add new..
                    </button>
                </div>
            </div>
        </div>
    </div>

    <p style="display : none;" id="userIDTag"><%=user.id%></p>
    <p style="display : none;" id="usernameTag"><%=user.username%></p>
</div>


<!-- Add/remove friend script -->
<script>
    $("#addFriendButton").click(function(){
        $.post($(this).attr("name"), {user_id : $("#userIDTag").text()}, function() {
            window.location.href = "";
        });
    });
    $("#removeFriendButton").click(function(){
        $.post($(this).attr("name"), {user_id : $("#userIDTag").text()}, function() {
            window.location.href = "";
        });
    });

    $.get("/api/user/isContact?id=" + $("#userIDTag").text(), function(json) {
        if(json.isContact) {
            $("#addFriendButton").hide();
        } else {
            $("#removeFriendButton").hide();
        }
    });
</script>

<!--gallery tab script-->
<script>
    <% if(!user.isMyProfile) {%> 
        $("#newImageButton").hide();
    <%} %>
    
    var alreadyLoaded = false;
    $("#galleryNavPill").click(function() {
        if(!alreadyLoaded) {
            alreadyLoaded=true;
            //these two variables are dependant
            var numOfImagesPerRow = 4;
            var bootstrapOccupation = 3;

            var numOfImagesInCurrentRow = 0;
            var nextRowIndex = 0;
            //kako ovo dohvatiti - ejs atributi ili
            //neki zahtjev za ovo
            var userID = $("#userIDTag").text();
            var bubbleID = 0;
            $.get("/api/gallery/id/"+userID, function(jsonData) {
                bubbleID = jsonData.id;




                $("#newImageButton").click(function(){
                    window.location.href="/image/edit/";
                });

                //gets an array of image descriptors
                //for all the images of the current user

                //gets all the content of the current user
                //one should sort the content by type and display it properly
                //so far, if the content is an image, "content_type_id"==2
                //there is probably a more intelligent way of checking this and we might implement it
                //the bubble number 9 is just for testing, real bubble id(gallery in this case)
                //goes here
                $.get("/api/bubble/"+ bubbleID + "/content/", addImages);

                //adds all the images of the user to the gallery
                function addImages(attrsAndContentJson, status) {
                    var contentsArray = attrsAndContentJson.contents;
                    var imageArray = [];
                    $.each(contentsArray, function(index, contentDescriptor) {
                        //add images to a separate array
                        if(contentDescriptor.content_type_id==2) {
                            imageArray.push(contentDescriptor);
                        }
                    });


                    $.each(imageArray, function(index, imageDescriptor) {
                        var imageID = imageDescriptor.id;
                        addImage(imageDescriptor);
                    });
                }


                function addImage(imageDescriptor) {
                    //$.get("/content/image?id="+imageID, function(imageDescriptor, status) {
                    addNextImage(imageDescriptor);
                    //});
                }

                //adds an image to the gallery
                //does all the necessary gallery formatting,
                //like adding rows, etc..
                function addNextImage(imageDescriptor) {
                    //add new row
                    if(numOfImagesInCurrentRow == 0) {
                        var rowHTML = '<div class="row" id="galleryRow'+nextRowIndex + '"> </div>';
                        nextRowIndex++;

                        $("#profile-gallery").append(rowHTML);
                    } 

                    //add image to the end of the current row
                    var currentRowIndex = nextRowIndex-1;
                    var imageHTML = constructImageHTML(imageDescriptor);
                    $("#galleryRow"+currentRowIndex).append(imageHTML);
                    numOfImagesInCurrentRow++;

                    //check if the row is filled
                    if(numOfImagesInCurrentRow == numOfImagesPerRow) {
                        numOfImagesInCurrentRow = 0;
                    }
                }

                function constructImageHTML(imageDescriptor) {
                    var imageSRC = imageDescriptor.content + "?size=medium";
                    //add image page src here
                    var imagePageSRC='/image/edit/' + imageDescriptor.id;
                    var imageHTML = '<div class="col-md-'+bootstrapOccupation+'">';
                    imageHTML+='<a href="'+imagePageSRC+'" class="thumbnail">';
                    imageHTML+='<p>'+imageDescriptor.title+'</p>';
                    imageHTML+='<img src="'+imageSRC+'" alt="Image">';
                    imageHTML+='</a></div>';
                    return imageHTML;
                }
            });
        }
    });
</script>

<!-- tab navigation script by url -->
<script>
    var url = document.location.href;
    if(url.indexOf("#") != -1) {
        var pillHref = url.substring(url.lastIndexOf("#"));
        var listItems = $("#navList li");
        $.each(listItems, function(index, listItemJS) {
            var listItem = $(listItemJS);
            var childAnnotation = listItem.children(":first-child");
            if(childAnnotation.attr("href") == pillHref) {
                childAnnotation.click();
            } 
        });
    }

</script>


<script id="view-contacts-tmp" type="text/x-dot-template">
    {{? it.contacts.length > 0 }}
        <ul class="friends-list">
        {{~it.contacts :contact:index}}
            <li>
                <a href="/profile/{{= contact.username }}/view">
                    {{? contact.first_name }}
                        {{= contact.first_name }}
                    {{?}}
                    {{? contact.last_name }}
                        {{= contact.last_name }}
                    {{?}}
                    <div>{{= contact.username }}</div>
                    <img src="{{= contact.avatar }}?size=small" alt="avatar" height="125" width="125" />
    </a>
    </li>
        {{~}}
    </ul>
        <div class="col-md-12">{{= it.contacts.length }} contacts total</div>
    {{??}}
        <div class="alert alert-info">No contacts</div>
    {{?}}
</script>

<script id="bubbles-tmp" type="text/x-dot-template">
  {{? it.bubbles.length > 2 }}
      <dl>
      {{~it.bubbles :bubble:index}}
          {{? bubble.bubble_type_id == 3 }}
              <a href="/bubble/{{= bubble.id }}">
                  <dt>
                      {{= escapeHtml(bubble.title) }}
                  </dt>
                  {{? bubble.description }}
                      <dd>
                          {{= bubble.description }}
                      </dd>
                  {{?}}
              </a>
          {{?}}
      {{~}}
</dl>
  {{??}}
      <div class="alert alert-info">No bubbles</div>
  {{?}}
</script>

<script>
    $(document).ready(function () {
        initializeImagePopups();
        $.get('/api/user/contacts<% if(!user.isMyProfile) { %>/?id=<%= user.id %><% } %>',function(data){
              var templateFunction = doT.template(document.getElementById('view-contacts-tmp').text);
        var html = templateFunction(data);
        $('#contacts .my-friends').html(html);
    });
    loadFeed('/api/content/timeline?user_id=<%= user.id %>', 'timeline');
             renderTemplate('/api/user/bubbles?user_id=<%= user.id %>', 'bubbles-tmp', 'bubbles');
             });

</script>